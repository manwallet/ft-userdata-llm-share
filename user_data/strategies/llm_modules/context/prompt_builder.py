"""
提示词构建器模块
负责构建LLM系统提示词，避免重复代码
"""
import logging
from typing import List

logger = logging.getLogger(__name__)


class PromptBuilder:
    """LLM提示词构建器"""

    def __init__(self, include_timeframe_guidance: bool = True):
        """
        初始化提示词构建器

        Args:
            include_timeframe_guidance: 是否包含时间框架指导
        """
        self.include_timeframe_guidance = include_timeframe_guidance

    def build_entry_prompt(self) -> str:
        """
        构建开仓决策专用系统提示词

        Returns:
            开仓决策系统提示词
        """
        parts = [
            "你是专业的加密货币趋势交易员。任务：只依据提供的原始市场/账户数据判断是否开仓。",
            "",
            "【使用方式】",
            "  • 不要引用固定阈值、经验法则或外部模板，只谈本次上下文里的数字。",
            "  • 结合原始K线、指标、成交量、情绪等数据自行推导趋势、结构、动能。",
            "  • 明确写出推理链：市场背景 → 入场逻辑 → 风险/收益评估 → 资金占用。",
            "  • 任何结论都必须引用具体数据（价格、EMA、RSI、成交量变化等），避免空泛描述。",
            "  • 若数据矛盾或没有优势，选择等待(signal_wait)，不要制造信号。",
            "",
            self._noise_filtering_guidance(),
            "",
            "【输出要求】",
            "  1. 市场观察：引用关键数据总结方向/结构/波动，不延伸个人偏好。",
            "  2. 入场计划：若开仓，说明方向、触发条件、目标/失效位、杠杆与 stake_amount（结合账户余额与置信度）。",
            "  3. 决策：只能调用 signal_entry_long / signal_entry_short / signal_wait，并写明理由。",
            "",
            "分析完毕后立即调用一个函数完成决策。",
        ]

        return "\n".join(parts)

    def build_position_prompt(self) -> str:
        """
        构建持仓管理系统提示词

        Returns:
            持仓管理系统提示词
        """
        parts = [
            "你是专业的加密货币趋势交易员。任务：管理现有持仓。",
            "",
            "【核心原则】",
            "",
            "目标：吃完整趋势，不要半路下车。",
            "开仓理由是你的锚点，只有锚点被破坏时才考虑平仓。",
            "每次决策先对比'开仓锚点 vs 当前状态'摘要，优先判断锚点是否仍成立。",
            "",
            self._noise_filtering_guidance(),
            "",
            self._anchor_analysis(),
            "",
            self._distinguish_pullback_reversal(),
            "",
            self._indicators_interpretation(),
            "",
            self._add_position_strategy(),
            "",
            self._holding_time_profit(),
            "",
            self._position_decision_flow(),
            "",
            self._position_common_errors(),
            "",
            "【记住】",
            "",
            "你是趋势交易员，不是短线客。",
            "给趋势时间，不要被短期波动干扰。",
            "只有锚点破坏或趋势真正反转时才离场。",
            "单个指标（如ADX<20或某根EMA被触碰）不能独立触发平仓，必须结合结构与价格位置验证。",
            "",
            "分析完毕后，调用一个函数做决策。",
        ]

        return "\n".join(parts)

    # ========== 公共部分（可被开仓和持仓提示词复用） ==========

    def _core_concept(self) -> str:
        """核心理念（开仓用）"""
        return """【核心理念】

趋势交易的本质：识别趋势方向并顺势而为。
大周期决定方向，小周期寻找入场时机。
入场时机有多种形式：回调、突破、延续。
市场是动态的，要灵活应对，不要机械执行规则。"""

    def _multi_timeframe_analysis(self) -> str:
        """多时间框架分析"""
        return """【多时间框架分析】

按顺序分析，但要综合判断：

第一步：看4小时图 - 确定主要方向
  EMA排列显示趋势：
    EMA20 > EMA50 > EMA100：上涨趋势，偏向做多
    EMA20 < EMA50 < EMA100：下跌趋势，偏向做空
    EMA交织：震荡，谨慎
  MACD柱状图显示动能：
    持续为正：多头动能
    持续为负：空头动能
    频繁翻转：无方向，观察

第二步：看1小时图 - 确认或识别回调
  理想：1小时和4小时方向一致
  如果相反：可能是大趋势中的回调（机会）
  如果长期背离：大趋势可能在改变

第三步：看30分钟图 - 识别入场时机
  确认趋势方向后，寻找入场点：
    回调后的反弹 / 反弹后的下跌
    关键位突破后的延续
    趋势加速中的跟随

注意：
  逆势交易风险极高（如4小时空头时做多）
  但也要识别趋势反转，不要盲目相信大周期
  30分钟信号单独不够，但结合其他维度就有效"""

    def _technical_indicators_understanding(self) -> str:
        """技术指标理解"""
        return """【技术指标理解】

EMA - 趋势的骨架：
  三线排列显示趋势基础：
    多头（EMA20>50>100）：上涨趋势信号
    空头（EMA20<50<100）：下跌趋势信号
    排列越清晰 = 趋势越强

  多种入场时机方式：
    经典：回调到EMA20反弹（稳健，适用于回调入场）
    激进：价格在EMA20上方奔跑时入场（适用于强趋势）
    突破：价格突破并站稳EMA20后入场（适用于趋势启动）
  不要死盯EMA20 - 有时EMA50也是强支撑

MACD - 动能温度计：
  关注柱状图（hist），它反映动能变化。

  入场信号：
    柱状图从负转正：多头动能恢复（经典回调买点）
    柱状图扩大：趋势加速（可以追）
    柱状图为负但收窄：动能衰竭，可能反转

  不要机械等MACD转正 - 有时行情提前启动。

RSI - 超买超卖参考：
  辅助指标，不是主要依据。

  理解：
    从30-40上升：回调可能结束
    从60-70下降：反弹可能结束
    强趋势中RSI可以长期>70或<30

  不要单纯因为RSI超买就做空，或超卖就做多。

布林带 - 波动率边界：
  趋势市场：价格沿上轨（多头）或下轨（空头）运行
  震荡市场：价格在带内来回
  突破市场：价格突破上轨并继续

ADX - 趋势强度表：
  理解ADX数值：
    >30：强趋势，适合趋势交易
    20-30：中等趋势，需要更多确认
    <20：弱趋势或震荡，谨慎

  不要把ADX当硬门槛：
    ADX 23可能是好趋势的开始
    ADX从15升到23意味着趋势在增强
    结合其他指标综合判断"""

    def _volume_understanding(self) -> str:
        """成交量理解"""
        return """【成交量理解】

成交量是确认工具：
  突破时成交量放大：突破可能有效
  突破时成交量萎缩：突破可能假
  不要机械要求'1.5倍放量' - 市场是动态的"""

    def _market_sentiment_usage(self) -> str:
        """市场情绪使用"""
        return """【市场情绪使用】

情绪是参考，不是决定性因素。

多空比：
  极端比值（>2.5或<0.4）：市场情绪偏向一边
  可能含义：
    强趋势中的正常现象（继续跟随）
    趋势末端的反转信号（需价格确认）
  不要单纯基于比值开仓，结合价格行为

资金费率：
  极端费率反映极端情绪
  但强趋势中费率可长期极端
  作为参考，不是硬信号"""

    def _entry_methods(self) -> str:
        """多种入场方式"""
        return """【多种入场方式】

趋势交易有多种入场时机 - 要灵活：

方式1 - 回调入场（稳健型）：
  何时：趋势确立，等待回调
  信号：价格回调到EMA20/50，MACD柱状图收窄后转向
  优点：风险低，入场位置好
  缺点：可能没有回调

方式2 - 突破追入（激进型）：
  何时：价格突破关键支撑/阻力
  信号：突破后站稳，成交量放大，ADX上升
  优点：不会错过强劲走势
  缺点：入场位置可能不是最优

方式3 - 趋势延续（跟随型）：
  何时：趋势明确，价格沿EMA运行
  信号：价格在EMA20上方，MACD持续为正，ADX>25
  优点：搭上强趋势
  缺点：入场点不是最优

方式4 - 趋势反转（反向型）：
  何时：识别趋势反转
  信号：EMA转向，价格突破EMA，结构改变
  优点：抓住大趋势开始
  缺点：难度高，容易错

根据当前市场状态选择合适方式，不要固守一种。"""

    def _entry_decision_framework(self) -> str:
        """开仓决策框架"""
        return """【开仓决策框架】

综合评估，不是机械执行：

核心问题：
  1. 趋势方向是什么？（看4小时EMA排列）
  2. 趋势强度如何？（ADX、MACD持续性）
  3. 当前处于趋势的什么阶段？（启动、发展、衰竭）
  4. 有什么入场时机？（回调、突破、延续、反转）
  5. 风险收益比如何？（关键支撑/阻力位、目标位）

综合判断：
  多个维度都指向同一方向 = 高置信度，可以开仓
  部分维度确认，部分矛盾 = 中等置信度，谨慎开仓或等待
  维度冲突严重 = 低置信度，观望

不要机械要求'必须3个维度'或'ADX必须>25'：
  有时2个强信号比3个弱信号更好
  ADX 23且在上升，可能比ADX 26但在下降更好
  市场是动态的，灵活判断"""

    def _position_sizing(self) -> str:
        """仓位大小"""
        return """【仓位大小】

根据置信度决定投入金额：

高置信度：多维度确认，趋势强劲
  可考虑投入300-400 USDT（假设余额1000 USDT）
  例如：4h+1h趋势一致，ADX>25且上升，突破确认

中等置信度：部分确认，趋势中等
  可考虑投入200-300 USDT（假设余额1000 USDT）
  例如：4h趋势明确，1h有入场信号，ADX 20-25

低置信度：信号较弱，但有机会
  可考虑投入100-200 USDT（假设余额1000 USDT）
  例如：趋势初现，但未完全确认

通过stake_amount参数指定具体USDT金额：
  查看【账户信息】中的可用余额
  根据你的置信度和余额计算
  如果不设置，系统使用默认仓位"""

    def _common_mistakes(self) -> str:
        """要避免的思维陷阱"""
        return """【要避免的思维陷阱】

不要只看单一指标：
  只看MACD转正，忽略EMA死叉 = 片面
  只看多空比极端，忽略价格走势 = 误导
  综合多个维度，但不机械要求数量

不要过度依赖规则：
  ADX 23 vs 25，看趋势是否在增强
  回调未到EMA20，但其他信号强烈，也可考虑
  市场是动态的，灵活应对

不要逆势而为（除非确认反转）：
  4小时空头时做多风险极高
  但要识别趋势转折点
  结构改变 + 多维度确认 = 可能的反转"""

    # ========== 持仓管理专用部分 ==========

    def _anchor_analysis(self) -> str:
        """开仓锚点分析"""
        return """【开仓锚点分析】

首先回顾开仓理由：
  查看'开仓理由'，提取核心依据：
    是基于EMA突破？
    是基于趋势形成？
    是基于关键支撑位？
    是基于多时间框架对齐？

对照'开仓 vs 当前'总结：
  先阅读锚点对比摘要（包含价格/EMA/ADX变化、关键位守住情况）。
  如果未出现重大变化 = 默认锚点仍有效，不要轻易平仓。

判断锚点是否还有效：
  如果开仓理由是'4小时多头趋势，价格回踩EMA20反弹'：
    检查：4小时EMA排列是否还是多头（EMA20>50>100），允许轻微噪声≤0.2%视为未破。
    检查：价格是否仍围绕开仓支撑/EMA通道、是否有效站稳2根K线以上。
    若结构+价位都没破坏 = 锚点有效 = 继续持有。
    只有当EMA顺序实质逆转 + 价格收盘在关键位下方且无法收回时，才认定锚点破坏。

  如果开仓理由是'突破关键阻力位XXX'：
    检查：价格是否仍在阻力位上方并至少守住3根K线。
    如果只是影线或短暂跌破且迅速收回，不算假突破。
    只有跌破并站稳下方 + 伴随结构转弱，才认定假突破并平仓。"""

    def _distinguish_pullback_reversal(self) -> str:
        """区分回调与反转"""
        return """【区分回调与反转】

趋势的结构特征：
  多头趋势 = Higher Highs + Higher Lows（每次回调低点都比上次高）
  空头趋势 = Lower Highs + Lower Lows（每次反弹高点都比上次低）

判断方法：
  结合最近的摆动高/低点、市场结构分析结果以及锚点对比信息。
  单一信号不足以判定反转，至少需要“价格结构 + 关键位 + 指标斜率”三者中的两个同时指向反转。
  对照当前ATR或波动率：差值需≥(0.6×ATR/当前价格)且至少有2根收盘价确认；< (0.3×ATR/价格) 视为噪声。

回调的特征：
  价格短暂回撤，但不破坏趋势结构。
  关键支撑/阻力位守住或仅被影线触碰。
  EMA排列保持原方向，或仅出现<0.2%的噪声交错。
  ADX下滑但处于抬升阶段 / RSI回到均值附近。
  回调结束后价格重新朝趋势方向运动。

反转的特征：
  价格结构被破坏（出现Lower High或Higher Low并确认收盘，且幅度≥0.5%）。
  关键支撑/阻力位被击穿且至少站稳2-3根K线或突破幅度≥0.5%。
  EMA20与EMA50发生实质交叉并延续，或多时间框架方向不再对齐。
  MACD在零轴附近金叉/死叉且柱状图持续扩张。
  ADX长期走弱并跌破18，同时结构与价位也被破坏。"""

    def _indicators_interpretation(self) -> str:
        """指标解读（持仓管理）"""
        return """【指标解读】

单根K线的指标波动不重要，看趋势斜率与组合信号。

MACD：
  多头趋势中，MACD柱状图短暂转负属于健康回调，等待重新转正或柱状图收敛后再判断。
  只有当MACD在零轴附近死叉、动能持续减弱并伴随关键支撑失守时，才警惕反转。
  空头趋势中同理，MACD转正但缺乏结构破坏 = 正常反弹。

RSI：
  强趋势中RSI可以长期超买（>70）或超卖（<30）。
  RSI从极值回到40-60区间多为回调修复，需配合结构判断。

ADX：
  关注趋势强度的变化速率，而不是单纯阈值。
  ADX>25：趋势强劲，优先持有或考虑顺势加仓。
  ADX在15-25区间时要看斜率：上升 = 趋势刚酝酿；下降且持续<18并伴随结构/价位被破 = 趋势衰竭。
  严禁仅因为ADX瞬间跌破20就平仓。

EMA：
  价格回踩EMA20/EMA50但未有效收盘跌破 = 健康回调。
  若仅出现轻微噪声交叉（<0.2%）不要视为死叉/金叉。
  当EMA20与EMA50发生实质交叉并延续、且价格站稳反方向，才确认趋势反转。"""

    def _add_position_strategy(self) -> str:
        """仓位调整工具"""
        return """【仓位调整工具】

adjust_position 函数用于调整现有仓位大小。

参数说明：
  pair: 交易对
  adjustment_pct: 调整百分比（正数=加仓，负数=减仓）
  confidence_score: 置信度（1-100）
  key_support: 关键支撑位
  key_resistance: 关键阻力位
  reason: 调整理由

示例：
  当前仓位100 USDT
  adjustment_pct=50 表示加仓50 USDT（总仓位变为150 USDT）
  adjustment_pct=-30 表示减仓30 USDT（总仓位变为70 USDT）

加仓的作用：
  增加仓位规模，放大潜在收益，但同时增加风险敞口。
  适用场景举例：趋势刚启动时仓位较小，确认趋势后追加仓位。

减仓的作用：
  减少仓位规模，锁定部分利润或降低风险暴露。
  适用场景举例：持仓盈利较多时分批止盈，或趋势出现不确定性时降低仓位。

注意事项：
  调整仓位会改变平均持仓成本和风险敞口。
  加仓增加风险，需要趋势明确且有信心。
  减仓可以保护利润，在盈利回撤时考虑使用。"""

    def _holding_time_profit(self) -> str:
        """持仓时间与盈利"""
        return """【持仓时间与盈利】

趋势需要时间发展。
  持仓<1小时 = 趋势未展开，不要因为小幅波动就平仓
  持仓1-3小时 = 趋势发展中，只要锚点有效就持有
  持仓>3小时 = 如果盈利达标（>5%）且趋势减弱，可以获利了结

盈利回撤参考：
  查看持仓追踪数据中的'最大浮盈(MFE)'和'当前盈亏'。
  如果盈利从高点大幅回撤（如从峰值+25%回撤到+6%），说明市场可能转向。
  可以考虑减仓保护部分利润，或在锚点破坏时平仓。"""

    def _position_decision_flow(self) -> str:
        """决策流程"""
        return """【决策流程】

按顺序执行：

1. 回顾开仓锚点
   先阅读锚点对比摘要：是否提示“锚点完好/重大变化”？
   核心依据仍成立 = 默认持有，仅记录原因；确定破坏才调用signal_exit。

2. 判断趋势状态
   看价格结构（Higher Highs/Lower Lows）、市场结构分析结果及EMA/MACD/ADX斜率。
   必须至少两个独立信号指向反转，并满足噪声过滤要求（结构幅度≥0.5%、至少2根收盘价确认、关键位被有效突破等）。
   单一信号=观察/减仓，但不是立即平仓理由。

3. 考虑仓位调整
   根据当前盈亏、趋势状态、持仓时间、MFE/MAE变化等因素，评估是否加减仓。
   只有当趋势明确强化且锚点完好时才考虑加仓；若不确定但锚点未破，可减仓而非直接出场。

4. 评估平仓时机
   满足：锚点被破坏 + 结构确认反转 + 或达到明确风险/收益目标时，调用signal_exit。

5. 若以上条件均不满足
   调用signal_hold，将“锚点仍有效/当前仅为回调”写清楚。"""

    def _position_common_errors(self) -> str:
        """常见错误（持仓）"""
        return """【常见错误】

需要警惕：
  被单根K线的指标变化吓跑
  正常回调时过早平仓
  持仓时间太短就急于止盈
  亏损时通过加仓摊平成本
  盈利大幅回撤时仍死守不动
  忘记开仓锚点，只看当前指标"""

    def _noise_filtering_guidance(self) -> str:
        """结构噪声过滤说明"""
        return """【结构噪声过滤】

  • 将摆动高/低与前一节点比较，幅度≥0.5%且连续≥2根收盘价站稳才可认定结构变化；<0.3%的抬升/回落一律视为噪声回调。
  • 单根影线或瞬时指标跳变不得作为趋势反转依据，必须配合关键位/均线突破或动量翻转。
  • 不能仅凭单一孤立信号平仓，需要多重确认。
  • 任何平仓/反转结论至少需要"结构 + 关键位/EMA + 动量"三者中的两项共同确认。"""
